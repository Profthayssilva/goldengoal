"use strict";(()=>{var e={};e.id=6910,e.ids=[6910],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},29239:(e,a,t)=>{t.r(a),t.d(a,{headerHooks:()=>v,originalPathname:()=>w,patchFetch:()=>y,requestAsyncStorage:()=>g,routeModule:()=>m,serverHooks:()=>h,staticGenerationAsyncStorage:()=>f,staticGenerationBailout:()=>A});var r={};t.r(r),t.d(r,{POST:()=>c});var n=t(95419),o=t(69108),s=t(99678),i=t(78070),l=t(9108),d=t(85269),u=t(84113),p=t(2563);async function c(e){let a=await (0,d.M)(e,["admin","gestor"]);if(a instanceof i.default)return a;try{let e=new Date,a=e.getMonth()+1,t=e.getFullYear(),r=`Mensalidade ${a.toString().padStart(2,"0")}/${t}`,n=new Date(t,a-1,10),o=await l.Z.aluno.findMany({include:{responsavel:!0}});if(!o.length)return i.default.json({ok:!0,mensagem:"Nenhum aluno cadastrado.",gerados:0,detalhes:[]});let s=[];for(let e of o){let a=e.responsavel;if(!a){s.push({aluno:e.nome,status:"ignorado",motivo:"Aluno sem respons\xe1vel vinculado"});continue}if(await l.Z.pagamento.findFirst({where:{alunoId:e.id,descricao:r}})){s.push({aluno:e.nome,status:"pulado",motivo:"Mensalidade j\xe1 existe"});continue}let t=a.asaasCustomerId;t||(t=(await (0,u.Jn)({name:a.nome,cpfCnpj:a.cpf??void 0,email:a.email??void 0,phone:a.telefone??void 0})).id,await l.Z.responsavel.update({where:{id:a.id},data:{asaasCustomerId:t}}));let o=Number(e.valorMensalidade??0),i=await (0,u.Z8)({customerId:t,value:o,description:r,dueDate:n.toISOString().split("T")[0]}),d=await l.Z.pagamento.create({data:{descricao:r,valor:o,vencimento:n,status:"PENDENTE",alunoId:e.id,responsavelId:a.id,asaasPaymentId:i.id||null,boletoUrl:i.bankSlipUrl||null,invoiceUrl:i.invoiceUrl||null,pixQrCode:i.pixQrCode||null,pixPayload:i.pixPayload||null}});if(a.telefone){let t=`
Ol\xe1 ${a.nome}!

A mensalidade de ${e.nome} foi gerada.

ðŸ“Œ *${r}*
ðŸ’° R$ ${o}
ðŸ“… Vencimento: ${n.toLocaleDateString("pt-BR")}

PIX para pagamento:
${i.pixPayload??"Acesse o painel para visualizar o QR Code"}

Obrigado! âš½
        `.trim();await (0,p.d)(a.telefone,t)}s.push({aluno:e.nome,status:"gerado",pagamentoId:d.id})}return i.default.json({ok:!0,descricaoMensalidade:r,gerados:s.filter(e=>"gerado"===e.status).length,detalhes:s})}catch(e){return console.error("ERRO ao gerar mensalidades:",e),i.default.json({error:"Erro interno ao gerar mensalidades."},{status:500})}}let m=new n.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/pagamentos/gerar-mensalidades/route",pathname:"/api/pagamentos/gerar-mensalidades",filename:"route",bundlePath:"app/api/pagamentos/gerar-mensalidades/route"},resolvedPagePath:"D:\\fut7\\app\\api\\pagamentos\\gerar-mensalidades\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:g,staticGenerationAsyncStorage:f,serverHooks:h,headerHooks:v,staticGenerationBailout:A}=m,w="/api/pagamentos/gerar-mensalidades/route";function y(){return(0,s.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:f})}},83807:(e,a,t)=>{t.d(a,{I8:()=>i});var r=t(78784),n=t(7529),o=t(9108);let{handlers:s,auth:i,signIn:l,signOut:d}=(0,r.ZP)({session:{strategy:"jwt"},providers:[{id:"credentials",name:"Credentials",type:"credentials",credentials:{},authorize:()=>null,options:{name:"credentials",credentials:{email:{label:"E-mail",type:"text"},password:{label:"Senha",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;let a=await o.Z.user.findUnique({where:{email:e.email}});return a&&a.hashedPassword&&await n.ZP.compare(e.password,a.hashedPassword)?{id:a.id,email:a.email??"",name:a.name??"",role:a.role}:null}}}],callbacks:{jwt:async({token:e,user:a})=>(a&&(e.id=a.id,e.role=a.role),e),session:async({session:e,token:a})=>(e.user&&(e.user.id=a.id,e.user.role=a.role),e)},pages:{signIn:"/login",error:"/login"}})},84113:(e,a,t)=>{t.d(a,{Jn:()=>s,Z8:()=>i,bZ:()=>o});let r=process.env.ASAAS_BASE_URL||"https://sandbox.asaas.com/api/v3",n=process.env.ASAAS_API_KEY;async function o(e,a={}){let t={"Content-Type":"application/json",access_token:n,...a.headers||{}},o=await fetch(`${r}${e}`,{...a,headers:t});if(!o.ok){let e=await o.text();throw console.error("[ASAAS] Erro:",o.status,e),Error("Erro ao comunicar com ASAAS")}return o.json()}async function s(e){let a={name:e.name,email:e.email??void 0,cpfCnpj:e.cpfCnpj??void 0,mobilePhone:e.phone??void 0};return e.address&&(a.address=e.address),await o("/customers",{method:"POST",body:JSON.stringify(a)})}async function i(e){let a={customer:e.customerId,billingType:"PIX",value:e.value,dueDate:e.dueDate,description:e.description};return await o("/payments",{method:"POST",body:JSON.stringify(a)})}n||console.warn("[ASAAS] âš ï¸ ASAAS_API_KEY n\xe3o configurada. Integra\xe7\xe3o ficar\xe1 inativa.")},9108:(e,a,t)=>{t.d(a,{Z:()=>n});let r=require("@prisma/client"),n=globalThis.prisma??new r.PrismaClient({log:["query","error","warn"]})},85269:(e,a,t)=>{t.d(a,{M:()=>o});var r=t(83807),n=t(78070);async function o(e,a){let t=await (0,r.I8)();if(!t?.user)return new n.default(JSON.stringify({error:"N\xe3o autenticado."}),{status:401});let o=(t.user.role||"").toLowerCase();return a.map(e=>e.toLowerCase()).includes(o)?{user:t.user}:new n.default(JSON.stringify({error:"Acesso negado."}),{status:403})}},2563:(e,a,t)=>{t.d(a,{d:()=>r});async function r(e,a){try{let t=process.env.WHATSAPP_TOKEN,r=process.env.WHATSAPP_PHONE_ID,n=process.env.WHATSAPP_API_URL;if(!t||!r||!n){console.error("[WHATSAPP] Vari\xe1veis .env ausentes.");return}let o={messaging_product:"whatsapp",to:e.replace(/\D/g,""),type:"text",text:{body:a}},s=await fetch(`${n}/${r}/messages`,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify(o)}),i=await s.json();if(console.log("[WHATSAPP] Enviado:",i),!s.ok)throw Error(JSON.stringify(i));return i}catch(e){return console.error("[WHATSAPP] Erro ao enviar:",e),null}}}};var a=require("../../../../webpack-runtime.js");a.C(e);var t=e=>a(a.s=e),r=a.X(0,[1638,6206,7529,8784],()=>t(29239));module.exports=r})();