"use strict";(()=>{var e={};e.id=7046,e.ids=[7046],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6113:e=>{e.exports=require("crypto")},63251:(e,a,t)=>{t.r(a),t.d(a,{headerHooks:()=>A,originalPathname:()=>S,patchFetch:()=>x,requestAsyncStorage:()=>w,routeModule:()=>v,serverHooks:()=>P,staticGenerationAsyncStorage:()=>y,staticGenerationBailout:()=>h});var r={};t.r(r),t.d(r,{GET:()=>g,POST:()=>f});var o=t(95419),n=t(69108),s=t(99678),i=t(78070),l=t(9108),d=t(18801);let u=d.Ryn({descricao:d.Z_8().min(3),valor:d.Rxh().positive(),status:d.Z_8(),vencimento:d.Z_8(),alunoId:d.Z_8(),responsavelId:d.Z_8(),asaasCustomerId:d.Z_8().optional(),asaasPaymentId:d.Z_8().optional(),pixQrCode:d.Z_8().optional(),pixPayload:d.Z_8().optional(),boletoUrl:d.Z_8().optional()});var p=t(85269),c=t(84113),m=t(2563);async function g(e){let a=await (0,p.M)(e,["admin","gestor"]);if(a instanceof i.default)return a;try{let{searchParams:a}=new URL(e.url),t=a.get("nome")??"",r=a.get("status")??"",o=a.get("dataDe")??"",n=a.get("dataAte")??"",s=await l.Z.pagamento.findMany({where:{...r&&{status:r},...t&&{responsavel:{nome:{contains:t,mode:"insensitive"}}},...o&&n&&{vencimento:{gte:new Date(o),lte:new Date(n)}}},include:{responsavel:!0,aluno:!0},orderBy:{vencimento:"desc"}});return i.default.json(s)}catch(e){return console.error("GET /api/pagamentos erro:",e),i.default.json({error:"Erro ao listar pagamentos."},{status:500})}}async function f(e){let a=await (0,p.M)(e,["admin","gestor"]);if(a instanceof i.default)return a;try{let a=await e.json(),t=u.safeParse(a);if(!t.success)return i.default.json({error:"Dados inv\xe1lidos."},{status:400});let{responsavelId:r,alunoId:o,descricao:n,valor:s,vencimento:d}=t.data,p=await l.Z.responsavel.findUnique({where:{id:r}});if(!p)return i.default.json({error:"Respons\xe1vel n\xe3o encontrado."},{status:404});let g=p.asaasCustomerId;g||(g=(await (0,c.Jn)({name:p.nome,cpfCnpj:p.cpf??void 0,email:p.email??void 0,phone:p.telefone??void 0})).id,await l.Z.responsavel.update({where:{id:r},data:{asaasCustomerId:g}}));let f=await (0,c.Z8)({customerId:g,value:s,description:n,dueDate:new Date(d).toISOString().split("T")[0]}),v=await l.Z.pagamento.create({data:{descricao:n,valor:s,vencimento:new Date(d),status:"PENDENTE",responsavelId:r,alunoId:o,asaasPaymentId:f.id||null,boletoUrl:f.bankSlipUrl||null,invoiceUrl:f.invoiceUrl||null,pixQrCode:f.pixQrCode||null,pixPayload:f.pixPayload||null}});if(p.telefone){let e=`
Ol\xe1 ${p.nome}!

Foi gerada uma cobran\xe7a:
ðŸ“Œ *${n}*
ðŸ’° Valor: R$ ${s}
ðŸ“… Vencimento: ${new Date(d).toLocaleDateString("pt-BR")}

Use este PIX para pagar:
${f.pixPayload??"Acesse o painel para ver o QR Code"}

Obrigado! âš½
`;await (0,m.d)(p.telefone,e)}return i.default.json(v)}catch(e){return console.error("POST /api/pagamentos erro:",e),i.default.json({error:"Erro ao criar pagamento."},{status:500})}}let v=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/pagamentos/route",pathname:"/api/pagamentos",filename:"route",bundlePath:"app/api/pagamentos/route"},resolvedPagePath:"D:\\fut7\\app\\api\\pagamentos\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:w,staticGenerationAsyncStorage:y,serverHooks:P,headerHooks:A,staticGenerationBailout:h}=v,S="/api/pagamentos/route";function x(){return(0,s.patchFetch)({serverHooks:P,staticGenerationAsyncStorage:y})}},83807:(e,a,t)=>{t.d(a,{I8:()=>i});var r=t(78784),o=t(7529),n=t(9108);let{handlers:s,auth:i,signIn:l,signOut:d}=(0,r.ZP)({session:{strategy:"jwt"},providers:[{id:"credentials",name:"Credentials",type:"credentials",credentials:{},authorize:()=>null,options:{name:"credentials",credentials:{email:{label:"E-mail",type:"text"},password:{label:"Senha",type:"password"}},async authorize(e){if(!e?.email||!e?.password)return null;let a=await n.Z.user.findUnique({where:{email:e.email}});return a&&a.hashedPassword&&await o.ZP.compare(e.password,a.hashedPassword)?{id:a.id,email:a.email??"",name:a.name??"",role:a.role}:null}}}],callbacks:{jwt:async({token:e,user:a})=>(a&&(e.id=a.id,e.role=a.role),e),session:async({session:e,token:a})=>(e.user&&(e.user.id=a.id,e.user.role=a.role),e)},pages:{signIn:"/login",error:"/login"}})},84113:(e,a,t)=>{t.d(a,{Jn:()=>s,Z8:()=>i,bZ:()=>n});let r=process.env.ASAAS_BASE_URL||"https://sandbox.asaas.com/api/v3",o=process.env.ASAAS_API_KEY;async function n(e,a={}){let t={"Content-Type":"application/json",access_token:o,...a.headers||{}},n=await fetch(`${r}${e}`,{...a,headers:t});if(!n.ok){let e=await n.text();throw console.error("[ASAAS] Erro:",n.status,e),Error("Erro ao comunicar com ASAAS")}return n.json()}async function s(e){let a={name:e.name,email:e.email??void 0,cpfCnpj:e.cpfCnpj??void 0,mobilePhone:e.phone??void 0};return e.address&&(a.address=e.address),await n("/customers",{method:"POST",body:JSON.stringify(a)})}async function i(e){let a={customer:e.customerId,billingType:"PIX",value:e.value,dueDate:e.dueDate,description:e.description};return await n("/payments",{method:"POST",body:JSON.stringify(a)})}o||console.warn("[ASAAS] âš ï¸ ASAAS_API_KEY n\xe3o configurada. Integra\xe7\xe3o ficar\xe1 inativa.")},9108:(e,a,t)=>{t.d(a,{Z:()=>o});let r=require("@prisma/client"),o=globalThis.prisma??new r.PrismaClient({log:["query","error","warn"]})},85269:(e,a,t)=>{t.d(a,{M:()=>n});var r=t(83807),o=t(78070);async function n(e,a){let t=await (0,r.I8)();if(!t?.user)return new o.default(JSON.stringify({error:"N\xe3o autenticado."}),{status:401});let n=(t.user.role||"").toLowerCase();return a.map(e=>e.toLowerCase()).includes(n)?{user:t.user}:new o.default(JSON.stringify({error:"Acesso negado."}),{status:403})}},2563:(e,a,t)=>{t.d(a,{d:()=>r});async function r(e,a){try{let t=process.env.WHATSAPP_TOKEN,r=process.env.WHATSAPP_PHONE_ID,o=process.env.WHATSAPP_API_URL;if(!t||!r||!o){console.error("[WHATSAPP] Vari\xe1veis .env ausentes.");return}let n={messaging_product:"whatsapp",to:e.replace(/\D/g,""),type:"text",text:{body:a}},s=await fetch(`${o}/${r}/messages`,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify(n)}),i=await s.json();if(console.log("[WHATSAPP] Enviado:",i),!s.ok)throw Error(JSON.stringify(i));return i}catch(e){return console.error("[WHATSAPP] Erro ao enviar:",e),null}}}};var a=require("../../../webpack-runtime.js");a.C(e);var t=e=>a(a.s=e),r=a.X(0,[1638,6206,7529,8784,8801],()=>t(63251));module.exports=r})();